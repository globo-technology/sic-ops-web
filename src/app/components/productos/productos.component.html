<div class="app-productos">
  <div class="d-flex flex-row align-items-center my-3">
    <h1 class="h3 m-0 flex-fill"><fa-icon [icon]="['fas', 'boxes']"></fa-icon> Productos</h1>
    <div class="text-right m-0">
      <button type="button" class="btn" (click)="isFiltersCollapsed = !isFiltersCollapsed"
              [attr.aria-expanded]="!isFiltersCollapsed" aria-controls="productosFiltersCollapse"
              [class.btn-outline-primary]="!isFiltersCollapsed" [class.btn-primary]="isFiltersCollapsed"
              ngbPopover="Filtros" triggers="mouseenter:mouseleave" placement="left">
        <fa-icon [icon]="['fas', 'filter']"></fa-icon>
      </button>
    </div>
  </div>
  <div id="productosFiltersCollapse" [ngbCollapse]="isFiltersCollapsed" class="mb-3">
    <form [formGroup]="filterForm" (ngSubmit)="filter()" class="border-bottom pt-0 pb-2 container-fluid">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="codODes">Código o descripción</label>
            <input type="text" class="form-control" id="codODes" formControlName="codODes">
          </div>
          <div class="form-group">
            <label for="idRubro">Rubro</label>
            <select class="form-control" id="idRubro" formControlName="idRubro">
              <option></option>
              <option *ngFor="let r of rubros" [value]="r.idRubro">{{ r.nombre }}</option>
            </select>
          </div>
          <app-proveedor-filtro formControlName="idProveedor"></app-proveedor-filtro>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="visibilidad">Visibilidad</label>
            <select class="form-control" id="visibilidad" formControlName="visibilidad">
              <option></option>
              <option *ngFor="let v of visibilidades" [value]="v">{{ v | titlecase }}</option>
            </select>
          </div>
          <div class="form-check form-group">
            <input class="form-check-input" type="checkbox" id="oferta" formControlName="oferta">
            <label class="form-check-label" for="oferta">
              Ofertas
            </label>
          </div>
          <div class="card card-body bg-light mb-3">
            <app-ordenar-por-filtro [values]="ordenarPorOptions" formControlName="ordenarPor" #ordernarPor></app-ordenar-por-filtro>
            <app-sentido-filtro formControlName="sentido" #sentido></app-sentido-filtro>
          </div>
        </div>
      </div>
      <ul class="text-right list-inline mb-0">
        <li class="list-inline-item">
          <button type="submit" class="btn btn-primary"><fa-icon [icon]="['fas', 'search']"></fa-icon></button>
        </li>
        <li class="list-inline-item">
          <button type="button" class="btn btn-outline-secondary" (click)="reset()"><fa-icon [icon]="['fas', 'trash']"></fa-icon></button>
        </li>
      </ul>
    </form>
  </div>
  <div class="alert alert-globo">
    <div *ngIf="applyFilters.length">
      Filtros aplicados:
      <ul class="pl-3">
        <li *ngFor="let f of applyFilters">
          {{ f.label }}:
          <app-mensaje-asicronico *ngIf="f.asyncFn" [asyncFn]="f.asyncFn"></app-mensaje-asicronico>
          <span *ngIf="!f.asyncFn">{{ f.value }}</span>
        </li>
      </ul>
    </div>
    <em>
      {{ totalElements }} resultado{{ totalElements == 1 ? '': 's' }}
      <span *ngIf="ordenarPorAplicado"> ordenado{{ totalElements == 1 ? '': 's' }} por {{ ordenarPorAplicado }}</span>
      <span *ngIf="sentidoAplicado"> con sentido {{ sentidoAplicado }}</span>
    </em>
  </div>
  <div class="productos my-2">
    <div *ngFor="let p of items" class="producto d-flex flex-column flex-sm-row align-items-sm-center border-bottom border-top py-2">
      <div class="d-flex flex-row flex-fill align-items-center">
        <div class="img-container px-2 flex-shrink-0 flex-grow-0">
          <img [src]="p.urlImagen ? p.urlImagen : 'https://res.cloudinary.com/hf0vu1bg2/image/upload/v1545616229/assets/sin_imagen.png'" alt="">
        </div>
        <div class="flex-fill d-flex flex-column">
          <span>
            <span class="mr-2 codigo">{{ p.codigo }}</span>
            <span *ngIf="p.oferta" class="badge badge-success">OFERTA {{ p.porcentajeBonificacionOferta }}%</span>
            <span *ngIf="!p.oferta && estaBonificado(p)" class="badge badge-success">BONIF. {{ p.porcentajeBonificacionPrecio }}%</span>
          </span>
          <span class="mr-2"><strong>{{ p.descripcion }}</strong></span>
          <span class="mr-2">Stock: <strong>{{ getCantidad(p) }} {{ p.nombreMedida }}</strong> - Otra Suc: {{ getCantOtrasSucursales(p) }} {{ p.nombreMedida }}</span>
          <span class="mr-2" *ngIf="p.bulto > 1">Llevando {{ p.bulto }} o más</span>
          <span class="mr-2">
            <span class="text-nowrap" *ngIf="!((p.oferta || estaBonificado(p)) && p.bulto == 1)">
              P.U. <span class="precio" [class.tachado]="(p.oferta || estaBonificado(p)) && p.bulto == 1">{{ p.precioLista | currency:'ARS':'symbol':'1.0-2' }}</span>
            </span>
            <span class="text-nowrap" *ngIf="p.oferta || estaBonificado(p)">
              P.U. {{ p.oferta ? "Oferta" : "Bonif."}} <span class="precio">{{ p.precioBonificado | currency:'ARS':'symbol':'1.0-2' }}</span>
            </span>
          </span>
        </div>
      </div>
      <div class="text-right flex-fill flex-shrink-0 flex-grow-0 px-2">
        <ul class="list-inline mb-0 text-center d-inline-block">
          <li class="list-inline-item">
            <button class="btn btn-primary fake-cursor" ngbPopover="Ver Detalle" placement="left" triggers="mouseenter:mouseleave" (click)="verProducto(p)">
              <fa-icon [icon]="['far', 'eye']"></fa-icon>
            </button>
          </li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-primary" (click)="loadMore()" *ngIf="(page + 1) < totalPages">Mas resultados</button>
    </div>
  </div>
</div>
