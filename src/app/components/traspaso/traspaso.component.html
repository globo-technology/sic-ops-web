<div class="app-traspaso my-3">
  <div class="d-flex flex-row flex-wrap justify-content-end align-items-center mb-2" *ngIf="!(loading)">
    <h1 class="h3 pr-2 mb-0 flex-fill">
      <a class="btn" placement="right" ngbPopover="Volver al Listado" triggers="mouseenter:mouseleave"
         (click)="volverAlListado()">
        <fa-icon [icon]="['fas', 'chevron-left']" [size]="'lg'"></fa-icon>
      </a>
      <fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon> Nuevo Traspaso
    </h1>
  </div>
  <form [formGroup]="form" (ngSubmit)="submit()" class="container-fluid mt-2" *ngIf="form">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group my-3">
          <label for="idSucursalOrigen">Sucursal Origen</label>
          <select class="form-control" id="idSucursalOrigen" required formControlName="idSucursalOrigen"
                  [ngClass]="{ 'is-invalid': submitted && f.idSucursalOrigen.errors }">
            <option></option>
            <option *ngFor="let s of sucursalesOrigen" [value]="s.idSucursal">{{ sucursalesService.getSucursalLabel(s) }}</option>
          </select>
          <div class="invalid-feedback" *ngIf="submitted && f.idSucursalOrigen.errors">
            <div *ngIf="f.idSucursalOrigen.errors.required">Requerido</div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group my-3">
          <label for="idSucursalDestino">Sucursal Destino</label>
          <select class="form-control" id="idSucursalDestino" formControlName="idSucursalDestino"
                  [ngClass]="{ 'is-invalid': submitted && f.idSucursalDestino.errors }">
            <option></option>
            <option *ngFor="let s of sucursalesDestino" [value]="s.idSucursal">{{ sucursalesService.getSucursalLabel(s) }}</option>
          </select>
          <div class="invalid-feedback" *ngIf="submitted && f.idSucursalDestino.errors">
            <div *ngIf="f.idSucursalDestino.errors.required">Requerido</div>
          </div>
        </div>
      </div>
    </div>
    <fieldset class="mb-3">
      <legend class="border-bottom py-2 mb-0">
        Productos
        <button type="button" class="btn btn-primary" (click)="addIdProductoConCantidad()">
          <fa-icon [icon]="['fas', 'plus']"></fa-icon>
        </button>
      </legend>
      <div class="custom-error-message" *ngIf="submitted && f.idProductoConCantidad.errors">
        <div *ngIf="f.idProductoConCantidad.errors.required">Se requiere especificar el traspaso de al menos un (1) producto.</div>
        <div *ngIf="f.idProductoConCantidad.errors.nonUniqueIdProducto">Se duplicaron productos.</div>
      </div>
      <div  formArrayName="idProductoConCantidad">
        <div class="d-flex flex-row align-items-center border-bottom pt-2 pb-0" *ngFor="let pc of idProductoConCantidad.controls; index as i" [formGroupName]="i.toString()">
          <div class="row flex-fill">
            <div class="col-md-6">
              <app-producto-filtro #producto formControlName="idProducto"></app-producto-filtro>
              <div class="custom-error-message error-message-fix" *ngIf="submitted && pc.get('idProducto').errors">
                <div *ngIf="pc.get('idProducto').errors.required">Requerido</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label [for]="'cantidad_' + i">Cantidad</label>
                <input class="form-control" type="number" min="1" [id]="'cantidad_' + i" required formControlName="cantidad"
                       [ngClass]="{ 'is-invalid': submitted && pc.get('cantidad').errors }">
                <div class="invalid-feedback" *ngIf="submitted && pc.get('cantidad').errors">
                  <div *ngIf="pc.get('cantidad').errors.required">Requerido</div>
                  <div *ngIf="pc.get('cantidad').errors.min">MÃ­nimo {{ pc.get('cantidad').errors.min.min | number:'1.0-2' }}</div>
                  <!--<div *ngIf="pc.get('cantidad').errors.insuficiente">
                    La cantidad ingresada ({{ pc.get('cantidad').errors.insuficiente.cantATraspasar }})
                    supera a la cantidad en la sucursal ({{ pc.get('cantidad').errors.insuficiente.cantEnSucursal }})
                  </div>-->
                </div>
              </div>
            </div>
          </div>
          <div class="text-right pl-2">
            <button type="button" class="btn btn-primary" ngbPopover="Eliminar" triggers="mouseenter:mouseleave" placement="left" (click)="removeIdProductoConCantidad(i)">
              <fa-icon [icon]="['fas', 'trash']"></fa-icon>
            </button>
          </div>
        </div>
      </div>
    </fieldset>
    <div class="text-right">
      <button type="submit" class="btn btn-primary">
        <fa-icon [icon]="['fas', 'check']" [size]="'lg'"></fa-icon> Guardar
      </button>
    </div>
  </form>
</div>
